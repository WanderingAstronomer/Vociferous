# Vociferous - Docker Compose
#
# Usage:
#   docker compose up              # CPU-only, X11
#   docker compose --profile gpu up  # with NVIDIA GPU acceleration
#
# Prerequisites:
#   - X11: run `xhost +local:docker` on the host before starting
#   - PulseAudio: should work out of the box on most Linux desktops
#   - GPU: install nvidia-container-toolkit and enable the NVIDIA runtime

services:
  vociferous:
    build: .
    container_name: vociferous
    restart: unless-stopped

    # --- Display (X11) ---
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - QT_QPA_PLATFORM=${QT_QPA_PLATFORM:-xcb}
      # PulseAudio
      - PULSE_SERVER=unix:${XDG_RUNTIME_DIR:-/run/user/1000}/pulse/native
      # Wayland (uncomment if using Wayland instead of X11)
      # - WAYLAND_DISPLAY=${WAYLAND_DISPLAY:-wayland-0}
      # - XDG_RUNTIME_DIR=/tmp/xdg
    volumes:
      # X11 socket
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # PulseAudio socket (for microphone access)
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/pulse:/run/user/1000/pulse:ro
      # Wayland socket (uncomment if using Wayland)
      # - ${XDG_RUNTIME_DIR:-/run/user/1000}/${WAYLAND_DISPLAY:-wayland-0}:/tmp/xdg/${WAYLAND_DISPLAY:-wayland-0}:ro
      # Persist application data across container restarts
      - vociferous-config:/root/.config/vociferous
      - vociferous-data:/root/.local/share/vociferous
      - vociferous-cache:/root/.cache/vociferous

    # --- Audio ---
    devices:
      - /dev/snd:/dev/snd          # ALSA sound devices

    # --- Input (for global hotkeys via evdev/pynput) ---
    # Needs access to /dev/input for keyboard capture
    # WARNING: This grants broad input device access to the container
    group_add:
      - audio
      - input
    volumes_from: []

    # --- Networking ---
    network_mode: host   # simplifies PulseAudio + D-Bus connectivity

    # --- Security ---
    # Required for pynput/evdev keyboard access
    cap_add:
      - SYS_RAWIO
    # Allow access to input devices
    privileged: false

    ipc: host  # shared memory for Qt

  # ---------- GPU variant (activate with --profile gpu) ----------
  vociferous-gpu:
    extends:
      service: vociferous
    container_name: vociferous-gpu
    profiles:
      - gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

volumes:
  vociferous-config:
  vociferous-data:
  vociferous-cache:
